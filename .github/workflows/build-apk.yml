name: Build APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: npm ci

      - name: 👷 Build APK
        run: eas build --platform android --profile preview --non-interactive

      - name: 📋 Build Summary
        run: |
          echo "## 🎉 Build Submitted Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📱 Android APK Build" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Submitted to EAS Build" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** preview (APK)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time:** ~10-15 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📥 Download APK" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for build completion (~15 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "2. Check build status: \`eas build:list\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Download from EAS dashboard or CLI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔗 Useful Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Check build status" >> $GITHUB_STEP_SUMMARY
          echo "eas build:list" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Download specific build" >> $GITHUB_STEP_SUMMARY
          echo "eas build:download [BUILD_ID]" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: 📋 Next Steps
        run: |
          echo "Build submitted successfully! 🎉"
          echo ""
          echo "📱 Your Android APK is building in EAS cloud"
          echo "⏳ Build time: ~10-15 minutes"
          echo "📥 Download will be available after completion"
          echo ""
          echo "🔗 Monitor build progress:"
          echo "   https://expo.dev/accounts/aidilsaputrakirsan/projects/TodoApp/builds"